#textdomain wesnoth-AD

#define INITIAL_TIME
4#enddef

[scenario]
    id=08_The_End_of_the_War
    name= _ "The End of the War"
    map_data="{~add-ons/Ashevieres_Dogs/maps/08_The_End_of_the_War.map}"

    [event]
    name=prestart

        {PLACE_FIRE 42 18}
        {PLACE_FIRE 38 16}
        {PLACE_FIRE 26 22}
        {PLACE_FIRE 33 10}
        {PLACE_FIRE 21 20}
    [/event]

    {IMPLEMENT_FIRES {INITIAL_TIME}}

    turns=-1
    next_scenario=null
    victory_when_enemies_defeated=no
    carryover_percentage=40
    carryover_add=yes
    current_time={INITIAL_TIME}

    {DEFAULT_SCHEDULE}

    {SCENARIO_MUSIC "through_the_gates.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_city_falls.ogg"}
    {EXTRA_SCENARIO_MUSIC "vengeful.ogg"}
    {EXTRA_SCENARIO_MUSIC "casualties_of_war.ogg"}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
    {EXTRA_SCENARIO_MUSIC "battle-epic.ogg"}
    {EXTRA_SCENARIO_MUSIC "northerners.ogg"}

    {AD_TRACK {JOURNEY_07_NEW} }

    [label]
        x,y=38,8
        text=_ "Northern gates"
        immutable=yes
    [/label]

    [label]
        x,y=48,28
        text=_ "Eastern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,23
        text=_ "Southern gates"
        immutable=yes
    [/label]

    [label]
        x,y=16,12
        text=_ "Dan’Tonk citadel"
        immutable=yes
    [/label]

    #define FIREBALL MAGE_ID X Y

        [animate_unit]
            flag=attack
                [filter]
                    id={MAGE_ID}
                [/filter]
                [facing]
                    x,y=15,12
                [/facing]
                [primary_attack]
                    range=ranged
                    type=fire
                [/primary_attack]
            hits=yes
        [/animate_unit]

        [scroll_to]
            x,y={X},{Y}
        [/scroll_to]

        {QUAKE "explosion.ogg"}
        {QUAKE "rumble.ogg"}
        {QUAKE "cave-in.ogg"}

        [item]
            halo="data/add-ons/Ashevieres_Dogs/images/projectiles/fireball-impact-[1~17].png"
            x={X}
            y={Y}
        [/item]

        [delay]
            time=900
        [/delay]

        [harm_unit]
            [filter]
                [filter_location]
                    x,y={X},{Y}
                [/filter_location]
            [/filter]
            damage_type=fire
            amount=25
            kill=yes
            fire_event=yes
            animate=yes
            experience=no
        [/harm_unit]

        {REMOVE_IMAGE {X} {Y}}

        {PLACE_FIRE {X} {Y}}    
    #enddef

    {STARTING_VILLAGES_ALL 7}

    {STARTING_VILLAGES 2 12}
    {STARTING_VILLAGES 3 12}
    {STARTING_VILLAGES 4 12}

    {STARTING_VILLAGES_AREA 5 32 27 10}
    {STARTING_VILLAGES_AREA 5 19 30 1}
    {STARTING_VILLAGES_AREA 6 40 16 8}
    {STARTING_VILLAGES_AREA 6 47 22 5}
    {STARTING_VILLAGES_AREA 6 35 9 1}
   
    [event]
    name=prestart 

        [capture_village]
            side=2
            x=57,57,32,13,7,39
            y=14,9,4,7,10,4
        [/capture_village]

        [capture_village]
            side=3
            x=36,29
            y=44,43
        [/capture_village]

        [capture_village]
            side=4
            x=6,12,5,19
            y=40,35,22,42
        [/capture_village]
    [/event]

    [side]
        side=1
        controller=human
        gold=150
        {INCOME 5 3 1}
        fog=no
        shroud=no
        share_vision=all
        {BAZUR_ARC_I}
        color=white
        team_name=bazur
        user_team_name= _ "Asheviere’s Forces"
        {FLAG_VARIANT ragged}
        save_id=bazur
    [/side]

    [side]
        side=2
        controller=ai
        gold=185
        income=9
        fog=no
        shroud=no
        share_vision=all
        {DOMMEL}
        recruit=Spearman,Pikeman,Javelineer,Bowman,Longbowman,Shock Trooper,Mage,Dragoon,Fencer,Cavalryman
        color=orange
        team_name=bazur
        user_team_name= _ "Asheviere’s Forces"
        {FLAG_VARIANT loyalist}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            recruitment_pattern=fighter,fighter,archer 
        [/ai]
    [/side]

    [side]
        {ASHEVIERE}
        color=red
        side=3
        controller=ai
        canrecruit=yes
        gold=185
        income=10
        recruit=Spearman,Bowman,Heavy Infantryman,Fencer,Swordsman,Pikeman,Longbowman,Cavalryman,Dragoon,Javelineer,Mage,Lieutenant
        team_name=bazur
        user_team_name=_"Asheviere’s Forces"
        {FLAG_VARIANT loyalist}
        save_id=queen
        [ai]
            {NO_SCOUTS}
            aggression=0.88
        [/ai]
    [/side]

    [side]
        defeat_condition=never
        color=black
        side=4
        controller=ai
        
        no_leader=yes
        gold=185
        income=16
        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Troll Whelp, Goblin Spearman,Orcish Warrior,Troll,Troll Rocklobber,Orcish Crossbowman,Goblin Knight,Goblin Impaler
        team_name=bazur
        user_team_name=_"Asheviere’s Forces"
        {FLAG_VARIANT ragged}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        {GOLD 150 175 200}
        income=20
        fog=no
        shroud=no
        share_vision=all
        {SIR_GREY}
        recruit=Heavy Infantryman,Shock Trooper,Iron Mauler,Peasant,Woodsman
        color=purple
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping=no
        [/ai]
    [/side]

    [side]
        side=6
        controller=ai
        {GOLD 150 175 200}
        income=20
        fog=no
        shroud=no
        share_vision=all
        {SIR_ELLAENT}
        recruit=Horseman,Knight,Lancer,Peasant,Woodsman
        color=blue
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping=no
        [/ai]
    [/side]

    {SILENTLY_LIMIT_LEADER_MOVES 5 1}
    {SILENTLY_LIMIT_LEADER_MOVES 6 1}
    {SILENTLY_LIMIT_LEADER_MOVES 7 3}

    [side]
        side=7
        controller=ai
        {GOLD 200 250 300}
        income=20
        fog=no
        shroud=no
        share_vision=all
        {BARON_RICHARD}
        recruit=Swordsman,Pikeman,Javelineer,Halberdier,Spearman,Lieutenant,Sergeant,Royal Guard,Bowman,Longbowman,Peasant,Woodsman
        color=green
        team_name=rebels
        user_team_name= _ "Rebel Forces"
        {FLAG_VARIANT long}
        [ai]
            {NO_SCOUTS}
            aggression=0.88
            grouping=no
        [/ai]
    [/side]

    {PEASANT_SIDE 8}
    {AD_CAPTURE_EVENT 8}
    
    {AD_RECRUIT_EVENT}
    {AD_LOYALS_EVENTS}

    {AD_MARAUDERS}
    {HERODEATH_ACT_I}

    #define BURNED_VILLAGE X Y 
    {VARIABLE_OP image rand "scenery/village-human-burned1.png","scenery/village-human-burned2.png","scenery/village-human-burned3.png","scenery/village-human-burned4.png"}
    {PLACE_IMAGE $image {X} {Y}}
    #enddef

    [event]
    name=prestart 

        {BURNED_VILLAGE 50 20}
        {BURNED_VILLAGE 30 25}
        {BURNED_VILLAGE 21 29}
        {BURNED_VILLAGE 13 19}
        {BURNED_VILLAGE 21 9}
        {BURNED_VILLAGE 41 12}
        {BURNED_VILLAGE 23 22}
        {BURNED_VILLAGE 45 18}
        {BURNED_VILLAGE 38 31}

        {LOYAL_UNIT 5 "Shock Trooper" 31 35}{GUARDIAN}
        {LOYAL_UNIT 5 "Shock Trooper" 33 35}{GUARDIAN}

        {LOYAL_UNIT 6 Knight 45 14}{GUARDIAN}

        {LOYAL_UNIT 7 Halberdier 16 15}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 18 14}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 19 13}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 19 11}{GUARDIAN}

        {IF_VAR Grey_defeated numerical_equals 1 (
            [then]
                [gold]
                    side=5
                    amount=-75 
                [/gold]
            [/then]
            )}

        {IF_VAR Ellaent_defeated numerical_equals 1 (
        [then]
            [gold]
                side=6 
                amount=-75 
            [/gold]
        [/then]
        )}

        {IF_VAR Richard_defeated numerical_equals 1 (
            [then]
                [gold]
                    side=7
                    amount=-75 
                [/gold]
            [/then]
            )}

        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [unstore_unit]
            variable=ghuvog 
            x,y=3,30
        [/unstore_unit]

        {MODIFY_UNIT id=Ghuvog side 4}
        {FULL_HEAL id=Ghuvog}

        [foreach]
            array=orc_recalls
            index_var=i 

            [do]
                {VARIABLE this_item.side 4}

                [unstore_unit]
                    variable=this_item
                    x,y=recall,recall 
                [/unstore_unit]
            [/do]
        [/foreach]

        [hide_unit]
            side=1
        [/hide_unit]

        {UNIT 3 "Arch Mage" 50 35 (
        id=BattleMage1
        ai_special=guardian 
        facing=nw
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        )}
        {UNIT 3 "Red Mage" 51 35 (
        id=BattleMage2
        ai_special=guardian 
        facing=nw
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        )}

        {UNIT 3 "Great Mage" 53 34 (
        id=Leollyn
        name=_ "Leollyn"
        profile=portraits/leollyn.webp
        ai_special=guardian 
        facing=nw
        [modifications]
            {TRAIT_AGED}
            {TRAIT_INTELLIGENT}
            {TRAIT_LOYAL_HERO_NOSLOT}
        [/modifications]
        )}
        
        {UNIT 3 "Red Mage" 54 33 (
        id=BattleMage4
        ai_special=guardian 
        
        [modifications]
            {TRAIT_LOYAL}
        [/modifications]
        )}

        {LOYAL_UNIT 7 Halberdier 36 8}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 38 9}{GUARDIAN}

        {LOYAL_UNIT 7 Halberdier 48 27}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 46 28}{GUARDIAN}

        {LOYAL_UNIT 7 Halberdier 18 23}{GUARDIAN}
        {LOYAL_UNIT 7 Halberdier 16 22}{GUARDIAN}

        {MODIFY_AI_ADD_GOAL 2 (
            [goal]
                id=target_2
                name=target_location
                [criteria]
                    x,y=39,8
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 3 (
            [goal]
                id=target_3
                name=target_location
                [criteria]
                    x,y=49,29
                [/criteria]
                value=50
            [/goal]
        )}

        {MODIFY_AI_ADD_GOAL 4 (
            [goal]
                id=target_4
                name=target_location
                [criteria]
                    x,y=15,24
                [/criteria]
                value=50
            [/goal]
        )}
    [/event]

    [event]
    name=start 

        [delay]
            time=300
        [/delay]

        {REMOVE_IMAGE 32 20}

        {PLACE_IMAGE scenery/trapdoor-open.png 32 20}

        [sound]
            name=mace-miss.ogg 
        [/sound]

        [delay]
            time=300
        [/delay]

        [unhide_unit]
            side=1
        [/unhide_unit]

        [recall]
            id=Isolde 
            x,y=31,20
            animate=yes
        [/recall]

        [recall]
            id=Aryn
            x,y=33,20
        [/recall]

        [if]
            [not]
                [have_unit]
                    id=Aryn
                    x,y=33,20
                [/have_unit]
            [/not]
        [then]
            [recall]
                side=1
                x,y=33,20
            [/recall]
        [/then]
        [/if]

        [recall]
            id=Ron
            x,y=32,21
        [/recall]

        [if]
            [not]
                [have_unit]
                    id=Ron
                    x,y=32,21
                [/have_unit]
            [/not]
        [then]
            [recall]
                side=1
                x,y=32,21
            [/recall]
        [/then]
        [/if]

        [if]
        [variable]
            name=save_chu 
            numerical_equals=1
        [/variable]

        [then]

        {REPEAT 6 (

        [recall]
            side=1
            race=monster
            placement=leader
            animate=yes
            animate=yes
        [/recall])}

        [/then]

        [/if]

        [message]
            speaker=Bazur 
            message=_ "Whoa, what a blast!!!"
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Keep bombarding the city. I want the rebel walls turned to dust before my fighters storm the gates."
        [/message]

        [message]
            speaker=Leollyn
            message=_ "Your Majesty, please do remember that our goal is not to destroy the city, but to capture it."
        [/message]

        [message]
            speaker=Asheviere
            message=_ "Do as you are told or you will be capturing it yourself — from the front lines!"
        [/message]

        [message]
            speaker=Leollyn
            message=_ "(I never thought I’d live to serve a queen like this!)"
        [/message]

        {FIREBALL Leollyn 30 14}

        [delay]
            time=300
        [/delay]

        {FIREBALL BattleMage4 29 25}

        [message]
            speaker=Sir_Ellaent
            message=_ "The royal mages are bombarding the city! De Ferres, what do we do?"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "At the battle of Weldyn you did not ask me what to do, Ellaent, but now you speak?"
        [/message]
        
        [message]
            speaker=Baron_Richard
            message=_ "I’ll tell you what to do: defend Dan’Tonk to our last drop of blood; be the rock against which Asheviere will break her teeth! They will tear themselves apart, they will run, and on their heels we will enter Weldyn, and you will recognize me as regent! Any objections?"
        [/message]

        [message]
            speaker=Sir_Ellaent
            message=_ "Not at all, my Lord Regent!"
        [/message]

        [message]
            speaker=Sir_Grey
            message=_ "There’s no turning back now; it’s to Weldyn or to the grave. I’m with you, Richard!"
        [/message]

        [message]
            speaker=Baron_Richard
            message=_ "To the walls, then! Let’s show this rebel scum that the spirit of Garard still lives!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "We must break through to the gates and open them to the royal army at once, or we will be crushed!"
        [/message]

        {PLACE_IMAGE items/gohere.png 37 9}

        [scroll_to]
            x,y=37,9
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 47 28}

        [scroll_to]
            x,y=47,28
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {PLACE_IMAGE items/gohere.png 17 23}

        [scroll_to]
            x,y=17,23
        [/scroll_to]

        [delay]
            time=300
        [/delay]
        
        [scroll_to_unit]
            id=Bazur 
        [/scroll_to_unit]

        [objectives]
            silent=no
                [objective]
                    description= _ "Open each gate by moving any unit to the marked hexes in front of each gate, so that your allies may enter"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Defeat the rebel leaders"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Bazur"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Isolde"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Asheviere"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Ghuvog"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Dommel"
                    condition=lose
                [/objective]
                {IS_LAST_SCENARIO}
                [note]
                    [show_if]
                        {VARIABLE_CONDITIONAL Ellaent_defeated numerical_equals 1}
                    [/show_if]
                    description=_ "Since you defeated Sir Ellaent in the Battle of Weldyn, he has 75 less gold."
                [/note]
                [note]
                    [show_if]
                        {VARIABLE_CONDITIONAL Grey_defeated numerical_equals 1}
                    [/show_if]
                    description=_ "Since you defeated Sir Grey in the Battle of Weldyn, he has 75 less gold."
                [/note]
                [note]
                    [show_if]
                        {VARIABLE_CONDITIONAL Richard_defeated numerical_equals 1}
                    [/show_if]
                    description=_ "Since you defeated Baron Richard in the Battle of Weldyn, he has 75 less gold."
                [/note]
                [note]
                    [show_if]
                        [have_unit]
                            id=Delfador
                        [/have_unit]
                    [/show_if]
                    description=_ "At the end of each of your turns, Delfador will call lightning down upon the marked hexes. Lightning deals 30-60 damage."
                [/note]
        [/objectives]
    [/event]

    [event]
    name=turn 2

        {FIREBALL BattleMage1 17 17}
        {FIREBALL BattleMage4 36 25}
    [/event]

    [event]
    name=turn 3

        {FIREBALL BattleMage2 24 10}
        {FIREBALL Leollyn 35 30}
    [/event]

    [event]
    name=turn 4
        {FIREBALL BattleMage2 45 23}
        {FIREBALL Leollyn 38 21}
    [/event]

    [event]
    name=turn 5
        {FIREBALL BattleMage1 29 32}
        {FIREBALL BattleMage4 20 30}
    [/event]

    [event]
    name=turn 6
        {FIREBALL BattleMage1 13 16}
        {FIREBALL BattleMage4 22 11}
    [/event]

    #define CHECK_GATES

        [if]
            [variable]
                name=unit.race 
                equals=human 
            [/variable]
        [then]
            {VARIABLE_OP gates_human add 1}

            [if]
                [variable]
                    name=gates_human 
                    numerical_equals=3
                [/variable]
            [then]
                [set_achievement]
                    content_for=ashevieres_dogs
                    id=ad_offical
                [/set_achievement]
            [/then]
            [/if]
        [/then]
        [/if]
    #enddef

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=17,23
            [/filter_location]
        [/filter] 

        {REMOVE_IMAGE 17 23}

        [message]
            speaker=unit 
            message=_ "I’m opening the gates!"
        [/message]

        [terrain]
            x=15,16,17
            y=23,23,24
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=4
            action=delete
            path=goal[target_4]
        [/modify_ai]

        [message]
            speaker=Ghuvog
            message=_ "Attack! Let’s pay back the pink-skins for their victory at Abez!"
        [/message]

        [event]
        name=side 4 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=47,28
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 47 28}

        [message]
            speaker=unit 
            message=_ "I’m opening the gates!"
        [/message]

        [terrain]
            x=47,48,49
            y=29,28,28
            terrain=Rr^Pr/o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=3
            action=delete
            path=goal[target_3]
        [/modify_ai]

        [message]
            speaker=Asheviere
            message=_ "Everything is going according to plan. Soldiers, march forward and cleanse this city of its rebel plague!"
        [/message]

        [event]
        name=side 3 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=moveto 
    first_time_only=yes 

        [filter]
            side=1 
            [filter_location]
                x,y=37,9
            [/filter_location]
        [/filter]

        {REMOVE_IMAGE 37 9}

        [message]
            speaker=unit 
            message=_ "I’m opening the gates!"
        [/message]

        [terrain]
            x=37,38,39
            y=8,8,9
            terrain=Rr^Pr\o
        [/terrain]

        [sound]
            name=flail-miss.ogg 
        [/sound]

        [redraw][/redraw] 

        [modify_ai]
            side=2
            action=delete
            path=goal[target_2]
        [/modify_ai]

        [message]
            side=2
            canrecruit=yes
            message=_ "Soldiers, attack! Forward, and we shall end this war in de Ferres’s citadel!"
        [/message]

        [event]
        name=side 2 turn 

            [sound]
                name=charge.ogg 
            [/sound]
        [/event]

        {CHECK_GATES}
    [/event]

    [event]
    name=enemies_defeated 

        [message]
            speaker=Bazur
            message=_ "All the rebel chiefs have been killed! We won the massacre!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "I can’t believe it. The war is over! I survived, I’ll live to see peace!"
        [/message]

        {SCROLL_TO 1 1}
        [delay]
            time=300
        [/delay]
        [sound]
            name=lightning-miss.ogg
        [/sound]
        [remove_item]
            image=lightning_marker
        [/remove_item]
        [remove_object]
            id=Delfador
            object_id=halo_delfador
        [/remove_object]
        [delay]
            time=500
        [/delay]
        [terrain]
            x,y=5,7
            radius=1
            terrain=Rrd 
        [/terrain]
        {MODIFY_TERRAIN Rrd 7 7}
        {MODIFY_TERRAIN Rrd 5 9}
        {MODIFY_TERRAIN Rrd 3 6}
        [delay]
            time=500
        [/delay]
        [delay]
            time=300
        [/delay]
        [message]
            speaker=Delfador
            message=_ "Alas, the city is lost! The triumph of Asheviere is the ruin of Wesnoth, for her rule shall surely be the death of all we have fought for. Only one forlorn hope now remains..."
        [/message]

        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        [store_unit]
            {FILTER id=Delfador}
            variable,kill=stored_Delfador,yes
        [/store_unit]
        {NAMED_UNIT 7 Roc $stored_Delfador.x $stored_Delfador.y roc_delfador "Delfador" (canrecruit=yes)} {FACING $stored_Delfador.facing}
        {ANIMATE_UNIT id=roc_delfador levelin}

        [delay]
            time=300 
        [/delay]

        {MOVE_UNIT id=roc_delfador 1 1}

        [kill]
            id=roc_delfador
            animate=no 
        [/kill]

        [message]
            speaker=Bazur
            message=_ "That Delfador of yours escaped."
        [/message]

        [message]
            speaker=Isolde
            message=_ "His magic may be powerful, but inside he is nothing more than a coward and a deceiver."
        [/message]

        [message]
            speaker=Bazur
            message=_ "How can that worm wield such power! I hope some day I kill him."
        [/message]

        [message]
            speaker=Isolde
            message=_ "I hope so too..."
        [/message]

        {SOUND "horn-signals/horn-7.ogg"}

        [delay]
            time=300
        [/delay]

        [message]
            speaker=Isolde
            message=_ "Do you hear that horn? I think the queen is entering the city."
        [/message]
        
        [hide_unit]
            side=1,2,3,4,5,6,7
        [/hide_unit]

        {FADE_TO_BLACK}

        {REMOVE_IMAGE 32 20}
        {PLACE_IMAGE scenery/trapdoor-closed.png 32 20}

        [kill]
            side=2,3,4,5,6,7
            canrecruit=no 
        [/kill]

        [put_to_recall_list]
            side=1
            [not]
                id=Isolde
            [/not]
            [not]
                id=Bazur
            [/not]
        [/put_to_recall_list]

        {TELEPORT_UNIT id=Bazur 31 19}
        {TELEPORT_UNIT id=Isolde 30 19}
        {TELEPORT_UNIT id=Dommel 30 20}
        {TELEPORT_UNIT id=Ghuvog 30 21}

        {FULL_HEAL canrecruit=yes}
        {FULL_HEAL id=Isolde}

        [modify_unit]
            [filter]
                race=orc,human 
            [/filter]
            facing=s
        [/modify_unit]

        [scroll_to]
            x,y=32,20 
        [/scroll_to]

        [delay]
            time=300
        [/delay]

        {CAPTURE_VILLAGES 3 32 20 100}

        {FADE_IN}

        [unhide_unit]
            side=1,2,3,4
        [/unhide_unit]

        {REPLACE_SCENARIO_MUSIC main_menu.ogg}

        {UNIT 3 "Royal Guard" 49 29 (id=guard1)}
        {MOVE_UNIT id=guard1 48 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard2)}
        {MOVE_UNIT id=guard2 46 28}

        {UNIT 3 "Royal Guard" 49 29 (id=guard3)}
        {MOVE_UNIT id=guard3 45 26}

        {UNIT 3 "Royal Guard" 49 29 (id=guard4)}
        {MOVE_UNIT id=guard4 43 27}

        {UNIT 3 "Royal Guard" 49 29 (id=guard5)}
        {MOVE_UNIT id=guard5 42 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard6)}
        {MOVE_UNIT id=guard6 40 25}

        {UNIT 3 "Royal Guard" 49 29 (id=guard8)}
        {MOVE_UNIT id=guard8 39 23}

        {UNIT 3 "Royal Guard" 49 29 (id=guard9)}
        {MOVE_UNIT id=guard9 37 24}

        {UNIT 3 "Royal Guard" 49 29 (id=guard10)}
        {MOVE_UNIT id=guard10 36 21}

        {UNIT 3 "Royal Guard" 49 29 (id=guard11)}
        {MOVE_UNIT id=guard11 34 22}

        {TELEPORT_UNIT id=Asheviere 49 29}
        {MOVE_UNIT id=Asheviere 35 22}

        [scroll_to]
            x,y=32,20
        [/scroll_to]

        [message]
            speaker=Asheviere 
            message=_ "All the rebel leaders are dead and Dan’Tonk lies at my feet. To whom do I owe this triumph?"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Me!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "<span size='small'>(punching Bazur in the side) Quiet, you.</span>"
        [/message]

        [message]
            speaker=Dommel
            message=_ "We were only following Your Majesty’s orders."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "As it should be. I almost wish Garard yet lived, if only so I could now see his face. I do believe I have bested him in the art of war?"
        [/message]

        [message]
            speaker=Dommel
            message=_ "Quite right, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "However, even the wisest orders mean nothing without capable executors. I am glad to have such subjects at hand."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Isolde, you have served me well. To infiltrate this stronghold was feat enough, but to have done so using only an unruly pack of orcs... Not many commanders could do that."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Hand me a sword!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "Take mine, queen!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "... Thank you. Kneel, Isolde. For your services to the kingdom, I knight you. Rise, madam, and wear your title with honor! I hope you will continue to serve the Crown faithfully."
        [/message]

        [message]
            speaker=Isolde
            message=_ "I... I will carry the sword until Your Majesty considers my duty done."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Excellent."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "General Dommel, you were one of Garard’s officers. At first, I doubted you. But you have proven your loyalty to the kingdom, not just to a person, and I appreciate that. In gratitude for your service, I appoint you commandant of Halstead Fortress, our great stronghold in the west."
        [/message]

        [message]
            speaker=Dommel
            message=_ "I would be honored to lead Halstead, Your Majesty! Rest assured, as long as I live, no enemy will breach its walls."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "As for you, Ghuvog, you have done me an invaluable favor, and have wrought great vengeance on your enemies. You may return to your lands or remain and recognize me as your sovereign."
        [/message]

        [message]
            speaker=Ghuvog
            message=_ "Graah, my warriors and I will stay with all youse humans. After Garard, the saurians, and the rebels, there’s not much left of Clan Blackcrest."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I am glad for your decision. I shall assuredly have great use for you and your clan in the coming years."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "And finally, the Whitefang orc. What was his name?"
        [/message]

        [message]
            speaker=Isolde
            message=_ "His name is Bazur, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Ah, yes, Bazur. You have proven yourself one of the best orcs in my service; having obeyed orders faithfully and been the least likely to abuse my favour. You and your veterans shall be my personal guard. You will come with me to Weldyn, where you will receive a proper welcome and be equipped with the best of my armoury."
        [/message]
        
        [message]
            speaker=Bazur
            message=_ "Finally! Now that sounds like a worthy reward!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "I will pretend I did not hear that and allow another chance for you to respond appropriately."
        [/message]

        [message]
            speaker=Isolde
            message=_ "<span size='small'>Answer: I serve Your Majesty.</span>"
        [/message]

        [message]
            speaker=Bazur
            message=_ "I serve Your Majesty!"
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Much better. General Dommel, is Dan’Tonk’s citadel still intact?"
        [/message]

        [message]
            speaker=Dommel
            message=_ "Mostly intact, Your Majesty."
        [/message]

        [message]
            speaker=Asheviere 
            message=_ "Then I will have a feast there in honour of our victory. You are all invited."
        [/message]

        [message]
            speaker=Dommel
            message=_ "Huzzah for Your Majesty!"
        [/message]

        [message]
            speaker=Isolde
            message=_ "Huzzah!"
        [/message]

        [message]
            speaker=Ghuvog
            message=_ "Huzzah!"
        [/message]

        [message]
            speaker=Bazur
            message=_ "HUZZZ-A-A-AH!"
        [/message]

        [endlevel] 
            result=victory
            carryover_report=no
            linger_mode=no
        [/endlevel]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Sir_Ellaent 
        [/filter] 

        [message]
            speaker=unit 
            message=_ "I will not run from fate again. I curse you, Asheviere, doom of Wesnoth!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You have annoyed me too long, Ellaent, for me to grant you a glorious death. Orcs, off with his head!"
        [/message]

        [message]
            race=orc
            scroll=no
            message=_ "Gladly!"
        [/message]

        [sound]
            name=axe.ogg 
        [/sound]
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Sir_Grey
        [/filter] 

        [message]
            speaker=unit 
            message=_ "You have won, Asheviere! I give myself up unto your mercy."
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "It is too late to give up, Grey. You missed your chance at Weldyn. Wizards, roast this swine in his own armor!"
        [/message]

        [message]
            type=Arch Mage
            scroll=no
            message=_ "Oh... Yes, Your Majesty..."
        [/message]

        {SOUND flame-big.ogg}
    [/event]

    [event]
    name=last_breath 

        [filter]
            id=Baron_Richard
        [/filter] 

        [message]
            speaker=unit
            message=_ "Cowards and fools! Garard must be spinning in his grave!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "You could have been king of Wesnoth, but you chose a dead drunkard king over a living queen. How does it feel to realize that as you die, Richard?"
        [/message]

        [message]
            speaker=unit 
            message=_ "Only a fool would let himself be drawn into your web of lies, Asheviere! I have remained loyal to my king and kingdom and I have no regrets. I only wish I could live to see how your reign will end; the reign of a lonely, resentful woman!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "!!!"
        [/message]

        [message]
            speaker=Asheviere
            scroll=no
            message=_ "Hang him from the tower!"
        [/message]

        [sound]
            name=tail.ogg 
        [/sound]
    [/event]

    ################################################################################################################################################################################
    # DELFADOR ARRIVES
    ################################################################################################################################################################################
    [event]
        name=turn 5
        first_time_only=yes
        [filter_condition]
            [have_unit]
                id=Baron_Richard 
            [/have_unit]
        [/filter_condition]

        #--------------------
        # CREATE DELFADOR
        #--------------------
        [unit]
            id=Delfador
            name= _ "Delfador"
            side=7
            unrenamable=yes
            type=Roc
            x,y=1,1
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        {TEAM_COLOR_OVERRIDE id=Delfador purple}
        
        {MOVE_UNIT type=Roc 5 7}
        {SOUND skill-polymorph.wav}
        {ANIMATE_UNIT id=Delfador levelout}
        {TRANSFORM_UNIT id=Delfador "Delfador L4"}
        {ANIMATE_UNIT id=Delfador levelin}

        #--------------------
        # DELFADOR AND RICHARD SPEAK
        #--------------------
        [message]
            speaker=Delfador
            message=_ "I am not too late! De Ferres’s colors still fly over Dan’Tonk!"
        [/message]
        [message]
            speaker=Baron_Richard
            message=_ "Delfador, you damned crook, where have you been all this time?!"
        [/message]
        [message]
            speaker=Delfador
            message=_ "Forgive me for the delay, de Ferres. I have been acting in secret, infiltrating Weldyn under Asheviere’s very nose, and have only just returned from deep council with the elves of the Aethenwood. I bring good tidings - our hope for a king is not yet lost!"
        [/message]
        [message]
            speaker=Baron_Richard
            message=_ "That’s all well and good, but while you were off scheming we were fighting and getting surrounded in our own city! Enough talk — unleash your magic against Asheviere’s rebels! This battle can yet be won!"
        [/message]
        [message]
            speaker=Delfador 
            message=_ "I fear the situation is grave, de Ferres. Orcs rampage across the heartland — look, they have even entered within your very walls! To fight here is to risk the whole war. Your men are loyal and brave, but strength of character cannot triumph against strength of arms."
        [/message]
        [message]
            speaker=Baron_Richard
            message=_ "Do you suggest I abandon my own city? I shan’t flee to some backwater port — Dan’Tonk is my home, and my home is where I shall stand. Wesnoth’s fate will be decided here and now — stand with me against the dark queen!"
        [/message]
        [message]
            speaker=Delfador 
            message=_ "So be it, Baron. Vengeance for our slain comrades, our slain friends, our slain king! Asheviere has sown war and she shall reap death!"
        [/message]

        #--------------------
        # SUMMON RAIN
        #--------------------
        [sound]
            name=lightning.ogg
        [/sound]
        {FLASH_BLUE (
            [object]
                id=halo_delfador
                take_only_once=no
                duration=forever
                [filter]
                    id=Delfador
                [/filter]
                [effect]
                    apply_to=halo
                    halo="halo/ring-[1~3].png:100"
                [/effect]
            [/object]
            [terrain]
                x,y=5,7
                radius=1
                terrain=Qxua^Es 
            [/terrain]
            {MODIFY_TERRAIN Gs      5 7}
            {MODIFY_TERRAIN Qxua^Es 7 7}
            {MODIFY_TERRAIN Qxua^Es 5 9}
            {MODIFY_TERRAIN Qxua^Es 3 6}
            [redraw][/redraw]
        )}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Delfador
            message=_ "Face the wrath of the storm!"
        [/message]
        
        #--------------------
        # LIGHTNING HELPER MACRO
        #--------------------
#define PREPARE_LIGHTNING FILTER DENOMINATOR
        [store_unit]
            [filter]
                {FILTER}
            [/filter]
            kill=no
            variable=stored_targets
        [/store_unit]
        {VARIABLE num_items $stored_targets.length}
        {VARIABLE_OP num_items divide {DENOMINATOR}}
        {VARIABLE_OP num_items add 1}
        
        [random_placement]
            [filter_location]
                [filter]
                    {FILTER}
                [/filter]
            [/filter_location]
            num_items=$num_items
            min_distance=0
            allow_less=yes
            variable=hex
            [command]
                [if] {VARIABLE_CONDITIONAL first_lightning equals yes}
                    [then]
                        {SCROLL_TO $hex.x $hex.y}
                        [delay]
                            time=250
                        [/delay]
                    [/then]
                [/if]
                
                [item]
                    x,y=$hex.x,$hex.y
                    name=lightning_marker
                    halo=items/lightning-marker.png~O(0.7)
                [/item]
                [redraw]
                [/redraw]
                
                [if] {VARIABLE_CONDITIONAL first_lightning equals yes}
                    [then]
                        [delay]
                            time=250
                        [/delay]
                    [/then]
                [/if]
            [/command]
        [/random_placement]
        {CLEAR_VARIABLE stored_targets,num_items}
#enddef
        #--------------------
        # PREPARE LIGHTNING
        #--------------------
        {VARIABLE first_lightning yes}
        [event]
            name=new turn
            first_time_only=no
            # handle lightning per-side, so that:
            # 1) we can give the player more lighting (remember that the player can dodge),
            # 2) we can allow lightning to hit Bazur but not other leaders, and
            # 3) we can ensure an even distribution across sides
            {PREPARE_LIGHTNING side=1 7}
            {PREPARE_LIGHTNING (
                side=2,3,4
                canrecruit=no
                [not]
                    id=BattleMage1,BattleMage2,Leollyn,BattleMage4
                [/not]
            ) 15}
            
            {CLEAR_VARIABLE first_lightning}
            [fire_event]
                name=delfador_asheviere_speak
            [/fire_event]
        [/event]
        
        #--------------------
        # LIGHTNING STRIKES
        #--------------------
        [event]
            name=side 1 turn end
            first_time_only=no
            [fire_event]
                name=first_lightning_strike
            [/fire_event]
            [store_items]
                item_name=lightning_marker
                variable=lightning_markers
            [/store_items]
            [foreach]
                array=lightning_markers
                variable=hex
                [do]
                    {SCROLL_TO $hex.x $hex.y}
                    [remove_item]
                        x,y=$hex.x,$hex.y
                        image=lightning_marker
                    [/remove_item]
                    [sound]
                        name=lightning.ogg 
                    [/sound]
                    {RANDOM 1,2,3}
                    [item]
                        name=lightning_bolt
                        halo=misc/blank-hex.png~SCALE(200,650)~BLIT(halo/lightning-bolt-$random-[1~4,4].png,0,0):75,misc/blank-hex.png:999
                        x,y=$hex.x,$hex.y
                    [/item]
                    [redraw]
                    [/redraw]
                    [delay]
                        time=250
                    [/delay]
                    {RANDOM 30,40,50,60}
                    [harm_unit]
                        [filter]
                            x,y=$hex.x,$hex.y
                        [/filter]
                        delay=0
                        fire_event=yes
                        amount=$random
                        kill=yes
                        animate=yes
                    [/harm_unit]
                    [delay]
                        time=250
                    [/delay]
                    [remove_item]
                        x,y=$hex.x,$hex.y
                        image=lightning_bolt
                    [/remove_item]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE lightning_markers,random}
        [/event]
        
        #--------------------
        # DELFADOR AND ASHEVIERE SPEAK
        #--------------------
        [event]
            name=delfador_asheviere_speak
            first_time_only=yes 
            [message]
                speaker=Asheviere
                #po: Asheviere's son, Eldred, is dead. To "reunite" Asheviere with him would be to kill her
                message=_ "I am surprised you had the courage to come here, Delfador. Are you here to try and reunite me with my son?"
            [/message]
            [message]
                speaker=Delfador
                message=_ "It was my arrogance that gave you your power and it is now my burden to take it away. I am here to do the right thing, Asheviere."
            [/message]
            [message]
                speaker=Asheviere
                message=_ "Then you will die like all the others!"
            [/message]
            [message]
                speaker=Bazur
                message=_ "Who is this Delfador?"
            [/message]
            [message]
                speaker=Isolde
                message=_ "Court mage, hero of Wesnoth, “The Great”, et cetera. He was the one who turned the orcs and lizards against each other at the Ford of Abez, thereby ending Garard’s War."
            [/message]
            [message]
                speaker=Bazur
                message=_ "That rascal! I loved that war!"
            [/message]
            [message]
                speaker=Isolde
                message=_ "Don’t talk nonsense, concentrate on our mission! And prepare for the worst — if Delfador really is as strong as they say, the sky itself will soon fall upon us..."
            [/message]
            [show_objectives] # refresh objectives, showing the note about lightning
            [/show_objectives]
        [/event]

        #--------------------
        # DELFADOR AND LEOLLYN SPEAK
        #--------------------
        [event]
            name=new turn 
            id=dialog_timer
            first_time_only=no 

            {VARIABLE_OP timer add 1}
            {IF_VAR timer numerical_equals 3 (
            [then]
                [message]
                    speaker=Leollyn
                    message=_ "Delfador, this is madness! Garard is long gone and whatever royal favoritism you enjoyed under him is gone too. For your own good, get off the battlefield and let bygones be bygones!"
                [/message]
                [message]
                    speaker=Delfador
                    message=_ "Leollyn, my old examiner. I can’t believe my eyes! How can you fight by Asheviere’s side after all she’s done? She orchestrated Garard’s assassination!"
                [/message]
                [message]
                    speaker=Leollyn
                    message=_ "Hmph! The way I hear it, you were more than complicit in those events. You forget that we are mages, not politicians. Whoever sits on the throne of Wesnoth, it’s our duty to help them."
                [/message]
                [message]
                    speaker=Delfador
                    message=_ "I would never help an evil queen destroy human cities. I thought better of you, Leollyn."
                [/message]
                {CLEAR_VARIABLE timer}
                [remove_event]
                    id=dialog_timer 
                [/remove_event]
            [/then]
            )}
        [/event]
    [/event]

    [event]
    name=die 
    first_time_only=no 

        [filter]
            side=5,6,7
            canrecruit=yes 
        [/filter]

        [gold]
            side=5,6,7
            amount={ON_DIFFICULTY 45 75 105}
        [/gold]
    [/event]

    [event]
        name=turn 10
        [filter_condition]
            [have_unit]
                id=Ron
            [/have_unit]
            [and]
                [have_unit]
                    id=Baron_Richard
                [/have_unit]
            [/and]
        [/filter_condition]
        [message]
            speaker=Baron_Richard
            message= _ "What is this...? The commander of my city guard fights beneath the enemy’s colours? Do my eyes deceive me?"
        [/message]
        [message]
            speaker=Ron
            message= _ "You should have deemed me of more worth than a posting to the catacombs, Baron! You do not deserve the loyalty of talent you fail to recognize."
        [/message]
        [message]
            speaker=Baron_Richard
            message= _ "Proud fool, it is because the catacombs were this city’s only weakness that I sent you to ward them! And for that you have betrayed our cause and the king’s memory? So be it, viper, you shall do us less harm in Asheviere’s camp than in our own."
        [/message]
    [/event]

    [event]
    name=turn 15 

        [event]
        name=last breath 

            [filter]
                side=2,3
                race=human 
                [not]
                    id=Isolde 
                [/not]
            [/filter]

            [filter_second]
                side=5,6,7
                race=human 
            [/filter_second]

            [message]
                speaker=unit 
                message=_ "$second_unit.name|? I thought you fell at the Ford, in battle against the orcs!"
            [/message]

            [message]
                speaker=second_unit 
                message=_ "It would have been better if we’d never met again, friend..."
            [/message]

            [message]
                speaker=unit
                message=_ "No... Curse this war!"
            [/message]
        [/event]
    [/event]

    [event]
    name=last breath 

        [filter]
            id=Baron_Richard
        [/filter]

        [filter_second_attack]
            type=pierce,blade 
            range=ranged 
        [/filter_second_attack]

        [set_achievement]
            content_for=ashevieres_dogs
            id=ad_armour
        [/set_achievement]
        
    [/event]
[/scenario]
